#!/usr/bin/env bash
#

shopt -s globstar

specificationClassNames () {
  find **/test-classes -name '*Spec*.class' \
    | egrep -v '[$]' \
    | perl -pe 's#.*?test[-]classes/##' \
    | perl -pe 's/[.]class$//' \
    | tr '/' '.'
}

individualTestNames () {
  ack --no-filename --nogroup --output='$1' '\s*(".*?") (in|should)\b' **/src/test | sort -u
}

matchingFiles () {
  ack --files-with-matches "$@" -- **/src/test
}

if [[ $# -eq 0 ]]; then
  individualTestNames
  exit 0
fi

declare -a specs=()
declare -a tests=( "$(individualTestNames | egrep "$*")" )

files="$(matchingFiles "$*")"
classes="$(specificationClassNames)"
projects="$(matchingFiles "$*" | perl -pe 's#/.*##' | sort -u)"
matches="$(for cn in $classes; do simple="${cn##*.}" && ack -1 -w "$simple" -- $files >/dev/null && echo "$cn"; done)"

for test in "${tests[@]}"; do
  for p in $projects; do
    echo sbtx \'$p/testOnly $matches -- -ex $test\'
  done
done
